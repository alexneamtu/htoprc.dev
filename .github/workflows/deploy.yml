name: Deploy
run-name: Deploy ${{ github.event_name == 'release' && 'production' || 'staging' }}

on:
  workflow_run:
    workflows: ["CI"]
    branches: [main]
    types: [completed]
  release:
    types: [published]
  workflow_dispatch:

jobs:
  determine-environment:
    # Skip entirely if triggered by workflow_run and CI failed
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      should_deploy: ${{ steps.set-env.outputs.should_deploy }}
    steps:
      - name: Determine environment
        id: set-env
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            # CI already passed (checked in job-level if condition)
            # Also check Security workflow passed for this commit
            SHA="${{ github.event.workflow_run.head_sha }}"
            SECURITY_STATUS=$(gh api repos/${{ github.repository }}/commits/${SHA}/check-runs --jq '.check_runs[] | select(.name == "Scan for secrets") | .conclusion' 2>/dev/null || echo "pending")

            if [ "$SECURITY_STATUS" = "success" ]; then
              echo "environment=staging" >> $GITHUB_OUTPUT
              echo "should_deploy=true" >> $GITHUB_OUTPUT
            else
              echo "Security check status: $SECURITY_STATUS - skipping deploy"
              echo "environment=staging" >> $GITHUB_OUTPUT
              echo "should_deploy=false" >> $GITHUB_OUTPUT
            fi
          fi

  deploy-web:
    needs: [determine-environment, deploy-api]
    if: needs.determine-environment.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      actions: read
    environment:
      name: ${{ needs.determine-environment.outputs.environment }}
      url: ${{ needs.determine-environment.outputs.environment == 'production' && 'https://htoprc.dev' || 'https://staging.htoprc.dev' }}

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event_name == 'release' && github.event.release.tag_name || github.sha }}

      - name: Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 10.28.0

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download parser build from CI
        if: github.event_name == 'workflow_run'
        uses: dawidd6/action-download-artifact@0bd50d53a6d7fb5cb921e607957e9cc12b4ce392 # v12
        with:
          workflow: ci.yml
          run_id: ${{ github.event.workflow_run.id }}
          name: parser-dist
          path: packages/htoprc-parser/dist

      - name: Build parser
        if: github.event_name != 'workflow_run'
        run: pnpm --filter @htoprc/parser build

      - name: Build web
        run: pnpm --filter @htoprc/web build
        env:
          VITE_API_URL: ${{ needs.determine-environment.outputs.environment == 'production' && 'https://api.htoprc.dev' || 'https://api-staging.htoprc.dev' }}
          VITE_CLERK_PUBLISHABLE_KEY: ${{ needs.determine-environment.outputs.environment == 'production' && secrets.VITE_CLERK_PUBLISHABLE_KEY_PROD || secrets.VITE_CLERK_PUBLISHABLE_KEY_DEV }}

      - name: Deploy Web to Cloudflare Pages
        id: deploy
        uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65 # v3.14.1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: ./apps/web
          command: pages deploy dist --project-name=htoprc-${{ needs.determine-environment.outputs.environment }} --branch=main
          packageManager: pnpm

      - name: Deployment Summary
        run: |
          echo "## Web Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ needs.determine-environment.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Project | htoprc-${{ needs.determine-environment.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.determine-environment.outputs.environment }}" = "production" ]; then
            echo "| Custom Domain | [htoprc.dev](https://htoprc.dev) |" >> $GITHUB_STEP_SUMMARY
            echo "| Release | ${{ github.event.release.tag_name }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Custom Domain | [staging.htoprc.dev](https://staging.htoprc.dev) |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Verify Web Deployment
        run: |
          if [ "${{ needs.determine-environment.outputs.environment }}" = "production" ]; then
            URL="https://htoprc.dev"
          else
            URL="https://staging.htoprc.dev"
          fi
          echo "Verifying deployment at $URL..."
          # Wait for deployment to propagate
          sleep 10
          # Check that the site returns 200
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "::error::Web deployment health check failed. Expected 200, got $HTTP_STATUS"
            exit 1
          fi
          echo "Web deployment verified successfully (HTTP $HTTP_STATUS)"

  deploy-api:
    needs: determine-environment
    if: needs.determine-environment.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      actions: read
    environment:
      name: ${{ needs.determine-environment.outputs.environment }}
      url: ${{ needs.determine-environment.outputs.environment == 'production' && 'https://api.htoprc.dev' || 'https://api-staging.htoprc.dev' }}

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event_name == 'release' && github.event.release.tag_name || github.sha }}

      - name: Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 10.28.0

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download parser build from CI
        if: github.event_name == 'workflow_run'
        uses: dawidd6/action-download-artifact@0bd50d53a6d7fb5cb921e607957e9cc12b4ce392 # v12
        with:
          workflow: ci.yml
          run_id: ${{ github.event.workflow_run.id }}
          name: parser-dist
          path: packages/htoprc-parser/dist

      - name: Build parser
        if: github.event_name != 'workflow_run'
        run: pnpm --filter @htoprc/parser build

      - name: Backup D1 Database (Production)
        if: needs.determine-environment.outputs.environment == 'production'
        uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65 # v3.14.1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: ./apps/api
          command: d1 export DB --env production --remote --output=backup-${{ github.run_id }}.sql
          packageManager: pnpm

      - name: Upload D1 Backup
        if: needs.determine-environment.outputs.environment == 'production'
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: d1-backup-${{ github.run_id }}
          path: apps/api/backup-${{ github.run_id }}.sql
          retention-days: 30

      - name: Run D1 Migrations
        uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65 # v3.14.1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: ./apps/api
          command: d1 migrations apply DB --env ${{ needs.determine-environment.outputs.environment }} --remote
          packageManager: pnpm

      - name: Deploy API to Cloudflare Workers
        uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65 # v3.14.1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: ./apps/api
          command: deploy --env ${{ needs.determine-environment.outputs.environment }}
          packageManager: pnpm

      - name: API Deployment Summary
        run: |
          echo "## API Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ needs.determine-environment.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Migrations | Applied |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.determine-environment.outputs.environment }}" = "production" ]; then
            echo "| DB Backup | d1-backup-${{ github.run_id }} (30 days retention) |" >> $GITHUB_STEP_SUMMARY
            echo "| Worker | htoprc-api-production |" >> $GITHUB_STEP_SUMMARY
            echo "| Custom Domain | [api.htoprc.dev](https://api.htoprc.dev) |" >> $GITHUB_STEP_SUMMARY
            echo "| Release | ${{ github.event.release.tag_name }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Worker | htoprc-api-staging |" >> $GITHUB_STEP_SUMMARY
            echo "| Custom Domain | [api-staging.htoprc.dev](https://api-staging.htoprc.dev) |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Verify API Deployment
        run: |
          if [ "${{ needs.determine-environment.outputs.environment }}" = "production" ]; then
            URL="https://api.htoprc.dev/api/health"
          else
            URL="https://api-staging.htoprc.dev/api/health"
          fi
          echo "Verifying API deployment at $URL..."
          # Wait for deployment to propagate
          sleep 5
          # Check health endpoint returns status: ok
          RESPONSE=$(curl -s "$URL")
          if ! echo "$RESPONSE" | grep -q '"status":"ok"'; then
            echo "::error::API deployment health check failed. Response: $RESPONSE"
            exit 1
          fi
          echo "API deployment verified successfully"
          echo "Response: $RESPONSE"

  notify-failure:
    needs: determine-environment
    if: needs.determine-environment.outputs.should_deploy == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Security Check Failed - Skip Deploy
        run: |
          echo "## Deployment Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Security check failed or is pending. Deployment was not attempted." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View CI Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})" >> $GITHUB_STEP_SUMMARY
