name: Bundle Size

on:
  pull_request:
    branches: [main]
    paths:
      - 'apps/web/**'
      - 'packages/**'
      - 'pnpm-lock.yaml'

jobs:
  bundle-size:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Checkout PR
        uses: actions/checkout@v6

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build parser
        run: pnpm --filter @htoprc/parser build

      - name: Build web (PR)
        run: pnpm --filter @htoprc/web build
        env:
          VITE_API_URL: https://api.htoprc.staging.alexneamtu.top
          VITE_CLERK_PUBLISHABLE_KEY: ${{ secrets.VITE_CLERK_PUBLISHABLE_KEY_DEV }}

      - name: Get PR bundle size
        id: pr_size
        run: |
          size=$(du -sb apps/web/dist | cut -f1)
          size_kb=$((size / 1024))
          echo "bytes=$size" >> $GITHUB_OUTPUT
          echo "kb=$size_kb" >> $GITHUB_OUTPUT

          # Get individual chunk sizes
          js_size=$(find apps/web/dist -name "*.js" -exec du -cb {} + | tail -1 | cut -f1)
          css_size=$(find apps/web/dist -name "*.css" -exec du -cb {} + | tail -1 | cut -f1)
          echo "js_kb=$((js_size / 1024))" >> $GITHUB_OUTPUT
          echo "css_kb=$((css_size / 1024))" >> $GITHUB_OUTPUT

      - name: Checkout main
        uses: actions/checkout@v6
        with:
          ref: main
          clean: false
          path: main-branch

      - name: Build web (main)
        id: main_build
        continue-on-error: true
        run: |
          cd main-branch
          pnpm install --frozen-lockfile
          pnpm --filter @htoprc/parser build
          pnpm --filter @htoprc/web build
        env:
          VITE_API_URL: https://api.htoprc.staging.alexneamtu.top
          VITE_CLERK_PUBLISHABLE_KEY: ${{ secrets.VITE_CLERK_PUBLISHABLE_KEY_DEV }}

      - name: Get main bundle size
        id: main_size
        run: |
          if [ -d "main-branch/apps/web/dist" ]; then
            size=$(du -sb main-branch/apps/web/dist | cut -f1)
            size_kb=$((size / 1024))
            js_size=$(find main-branch/apps/web/dist -name "*.js" -exec du -cb {} + | tail -1 | cut -f1)
            css_size=$(find main-branch/apps/web/dist -name "*.css" -exec du -cb {} + | tail -1 | cut -f1)
          else
            size=0
            size_kb=0
            js_size=0
            css_size=0
          fi
          echo "bytes=$size" >> $GITHUB_OUTPUT
          echo "kb=$size_kb" >> $GITHUB_OUTPUT
          echo "js_kb=$((js_size / 1024))" >> $GITHUB_OUTPUT
          echo "css_kb=$((css_size / 1024))" >> $GITHUB_OUTPUT

      - name: Calculate diff
        id: diff
        run: |
          pr=${{ steps.pr_size.outputs.bytes }}
          main=${{ steps.main_size.outputs.bytes }}

          if [ "$main" -eq 0 ]; then
            diff_bytes=0
            diff_percent="N/A"
            status="new"
          else
            diff_bytes=$((pr - main))
            diff_percent=$(echo "scale=2; ($diff_bytes * 100) / $main" | bc)
            if [ "$diff_bytes" -gt 51200 ]; then
              status="warning"
            elif [ "$diff_bytes" -gt 0 ]; then
              status="increase"
            elif [ "$diff_bytes" -lt 0 ]; then
              status="decrease"
            else
              status="unchanged"
            fi
          fi

          echo "bytes=$diff_bytes" >> $GITHUB_OUTPUT
          echo "kb=$((diff_bytes / 1024))" >> $GITHUB_OUTPUT
          echo "percent=$diff_percent" >> $GITHUB_OUTPUT
          echo "status=$status" >> $GITHUB_OUTPUT

      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: Bundle Size Report

      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v5
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            ## Bundle Size Report

            | Metric | PR | Main | Diff |
            |--------|---:|-----:|-----:|
            | **Total** | ${{ steps.pr_size.outputs.kb }} KB | ${{ steps.main_size.outputs.kb }} KB | ${{ steps.diff.outputs.kb }} KB (${{ steps.diff.outputs.percent }}%) |
            | JavaScript | ${{ steps.pr_size.outputs.js_kb }} KB | ${{ steps.main_size.outputs.js_kb }} KB | - |
            | CSS | ${{ steps.pr_size.outputs.css_kb }} KB | ${{ steps.main_size.outputs.css_kb }} KB | - |

            ${{ steps.diff.outputs.status == 'warning' && '> **Warning:** Bundle size increased by more than 50KB!' || '' }}
            ${{ steps.diff.outputs.status == 'decrease' && '> **Great job!** Bundle size decreased!' || '' }}
